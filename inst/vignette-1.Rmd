---
title: "Experimental Design"
author: "Maria Cuellar & Heike Hofmann"
date: "`r Sys.Date()`"
fig_caption: yes
bibliography: references.bib
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = FALSE,
  fig.width = 8,
  fig.height = 4
)
library(tidyverse)
#library(markers)
```

# Experimental Setup

Data is included (for now) as part of the package:

```{r, echo = TRUE}
# loads object toolmarks
data(toolmarks)
```

Each signature is individualized by tool (1-20), size (S, M, L), mark (1-8), side (A,B), angle (60, 70, 80), direction (Fo/Ba)

```{r signatures}
signatures <- toolmarks %>% 
  group_by(tool, size, mark, side, angle, direction) %>%
  tidyr::nest()
```

Currently, there are `r nrow(signatures)` signatures collected. Figure @fig-overview contains an overview of the status quo.

```{r overview, out.width="\\textwidth", fig.cap="Overview of all collected signatures under each one of the experimental conditions. Each cell should be filled with a bar of height 8."}
signatures %>% 
  ggplot(aes(x = tool, fill = size)) + geom_bar() +
  facet_grid(side+ direction+angle~size, drop = TRUE, 
             scales = "free", space = "free") +
  scale_y_continuous(breaks=c(0,4,8))
```

All cells in this overview will, eventually, be filled in.

Align all signatures made by the same edge (side) of the same tool (tool & size), regardless of angle, direction, and repetition:

```{r echo=TRUE, eval=FALSE}
if (file.exists("aligned_signatures.rds")) {
  align_all <- readRDS("aligned_signatures.rds")
} else {
  align_all <- toolmarks %>%
    mutate(mark_angle_direction = sprintf("%s-%s-%s",mark,angle, direction)) %>%
    group_by(tool, size, side) %>% 
    tidyr::nest() %>%
    mutate(
      data = data %>% purrr::map(
        .f = function(d) {
          sig_align_set(d, value = signature,  group = mark_angle_direction, min.overlap=250)
        }
      )
    )
  saveRDS(align_all, "aligned_signatures.rds")
}

``` 

| Tool 1S - Edge A       | **Tool 1S - Edge B**   |
|------------------------|------------------------|
| ![](images/01-A-S.png) | ![](images/01-B-S.png) |

```{r, fig.cap="Sides A and B of tool 1S", fig.keep='all', out.width='0.5\textwidth', eval=FALSE}
align_all$data[[1]] %>% ggplot(aes(x = aligned_x, y = signature)) + 
  geom_line(aes(colour = mark_angle_direction)) +
  ggtitle(paste(align_all[1,1:3], sep="-", collapse="-"))

align_all$data[[2]] %>% ggplot(aes(x = aligned_x, y = signature)) + 
  geom_line(aes(colour = mark_angle_direction)) +
  ggtitle(paste(align_all[1,1:3], sep="-", collapse="-"))
```

## Quality control

For the marks of each tool edge, make sure that the alignment worked and we have good marks. The result is included in [aligned.pdf](aligned.pdf).

Generally: marks with signatures above a value of 0.01 seem to suffer from outliers along the boundaries of the profile. It would be helpful for the analysis to re-do the signature extraction for these profiles (e.g. tool 1S, edge A, mark 2, backwards direction).

```{r eval=FALSE, echo=FALSE, fig.width = 8, fig.height = 10}
align_all <- align_all %>% 
  mutate(
    plot = data %>% purrr::map(
      .f = function(data) {
        data %>% ggplot(aes(x = aligned_x, y = signature)) + 
  geom_line(aes(colour = mark_angle_direction)) +
          theme_bw() + 
          theme(legend.position="none")
      }
    )
  )

for (i in 1:nrow(align_all)) {
  align_all$plot[[i]] <- align_all$plot[[i]] + 
    ggtitle(paste(align_all[i,1:3], sep="-", collapse="-"))
}

library(gridExtra)

ml = do.call(marrangeGrob, list(align_all$plot, nrow=4, ncol=2))
ggsave(plot=ml, filename="aligned.pdf", width = 16, height = 20)       

aligned <- align_all %>% select(-plot) %>% 
  tidyr::unnest(col = data)
saveRDS(aligned, file="toolmarks-aligned.rds")
```

For tool 1S above, we see that edge B is aligned well across all scans. Edge A seems also be aligned well, however, we see that there are two main patterns in the extracted signatures. From the image below we see that these two main patterns can be explained by the directionality of making the mark:

```{r}
aligned <- readRDS("toolmarks-aligned.rds")
aligned %>% 
  filter(tool=="01", side=="A", size=="S") %>%
  ggplot(aes(x =aligned_x, y = signature, colour = mark_angle_direction)) +
  geom_line() + facet_grid(.~direction) +
  theme_bw() +
  theme(legend.position = "none") +
  ggtitle("Tool 1S, Edge A") +
  ylim(c(-0.01, 0.01))
```

There seems to be generally a bit more variability on the left side of the mark when scraping the tool backwards across the surface.

Some of the alignments need to be re-done, e.g.:

### Tool 2L

```{r, fig.keep='all', out.width='.5\textwidth', eval=FALSE}
aligned %>% 
  filter(tool == "02", size=="L", side=="A") %>%
  ggplot(aes(x = aligned_x, y = signature)) +
  geom_line(aes(colour = mark_angle_direction)) +
  theme_bw() +
  ggtitle("Tool 2L-A") +
  theme(legend.position = "none")

aligned %>% 
  filter(tool == "02", size=="L", side=="B") %>%
  ggplot(aes(x = aligned_x, y = signature)) +
  geom_line(aes(colour = mark_angle_direction)) +
  theme_bw() +
  ggtitle("Tool 2L-B") +
  theme(legend.position = "none")

```

```{r, fig.keep='all', fig.cap="Alignment of 2L-A by angle."}
long <- 
  toolmarks %>%
  mutate(
    mark_angle_direction =
      sprintf("%s-%s-%s",mark,angle,direction)
  ) %>%
  filter(tool == "02", side=="A", size=="L") %>%
  group_by(angle) %>% tidyr::nest() %>%
  mutate(
    aligned = data %>% purrr::map(
      .f = function(d) {
        d %>%  sig_align_set(value = signature,  
                group = mark_angle_direction, 
                min.overlap = 500)
      }
    )    
  )
long$aligned[[1]] %>% 
  ggplot(aes(x = aligned_x, y = signature)) +
  geom_line(aes(colour = mark_angle_direction)) +
  theme_bw()
long$aligned[[2]] %>% 
  ggplot(aes(x = aligned_x, y = signature)) +
  geom_line(aes(colour = mark_angle_direction)) +
  theme_bw()
long$aligned[[3]] %>% 
  ggplot(aes(x = aligned_x, y = signature)) +
  geom_line(aes(colour = mark_angle_direction)) +
  theme_bw()
```

Signature from 4-60-Fo seems like it was reversed.

```{r}
long <- 
  toolmarks %>%
  mutate(
    mark_angle_direction =
      sprintf("%s-%s-%s",mark,angle,direction)
  ) %>%
  filter(tool == "02", side=="A", size=="L")

long <- long %>% arrange(x) %>% 
  group_by(mark_angle_direction) %>%
  mutate(
    x = ifelse(mark_angle_direction=="4-60-Fo", -x, x)
  )

long <- long %>% arrange(x)

long <- long %>%
  group_by(angle) %>% tidyr::nest() %>%
  mutate(
    aligned = data %>% purrr::map(
      .f = function(d) {
        d %>%  sig_align_set(value = signature,  
                group = mark_angle_direction,
                min.overlap = 500)
      }
    )    
  )

long$aligned[[1]] %>% 
  ggplot(aes(x = aligned_x, y = signature)) +
  geom_line(aes(colour = mark_angle_direction)) +
  theme_bw()
```

Once the signature 4-60-Fo is reversed, all signatures of tool T01L edge A can be aligned in one go across angles.

```{r}
long <- long %>% select(-aligned) %>%
  tidyr::unnest(col=data)


long <- long %>% sig_align_set(value = signature,  
                group = mark_angle_direction,
                min.overlap = 500)

long %>% 
  ggplot(aes(x = aligned_x, y = signature)) +
  geom_line(aes(colour = mark_angle_direction)) +
  theme_bw() +
  facet_grid(angle~.)
```

```{r, fig.keep='all', fig.cap="Alignment of 2L-B by angle."}
long <- 
  toolmarks %>%
  mutate(
    mark_angle_direction =
      sprintf("%s-%s-%s",mark,angle,direction)
  ) %>%
  filter(tool == "02", side=="B", size=="L") %>%
  group_by(angle) %>% tidyr::nest() %>%
  mutate(
    aligned = data %>% purrr::map(
      .f = function(d) {
        d %>%  sig_align_set(value = signature,  
                group = mark_angle_direction,
                min.overlap = 500)
      }
    )    
  )
long <- long %>% arrange(angle)
long$aligned[[1]] %>% 
  ggplot(aes(x = aligned_x, y = signature)) +
  geom_line(aes(colour = mark_angle_direction)) +
  theme_bw()
long$aligned[[2]] %>% 
  ggplot(aes(x = aligned_x, y = signature)) +
  geom_line(aes(colour = mark_angle_direction)) +
  theme_bw()
long$aligned[[3]] %>% 
  ggplot(aes(x = aligned_x, y = signature)) +
  geom_line(aes(colour = mark_angle_direction)) +
  theme_bw()
```

One signature (mark = 3) under a 60 degree angle is not aligned properly.

```{r}
long$aligned[[1]] <- long$aligned[[1]] %>% 
  mutate(
    aligned_x = ifelse(mark_angle_direction=="3-60-Fo",aligned_x+130,aligned_x)
  )
long$aligned[[1]] %>% 
  ggplot(aes(x = aligned_x, y = signature)) +
  geom_line(aes(colour = mark_angle_direction)) +
  theme_bw()
```

### Tool 3L

```{r}
long <- 
  toolmarks %>%
  mutate(
    mark_angle_direction =
      sprintf("%s-%s-%s",mark,angle,direction)
  ) %>%
  filter(tool == "03", side=="A", size=="L") %>%
  group_by(angle) %>% tidyr::nest() %>%
  mutate(
    aligned = data %>% purrr::map(
      .f = function(d) {
        d %>%  sig_align_set(value = signature,  
                group = mark_angle_direction,
                min.overlap = 500)
      }
    )    
  )
long <- long %>% arrange(angle)
long$aligned[[1]] %>% 
  ggplot(aes(x = aligned_x, y = signature)) +
  geom_line(aes(colour = mark_angle_direction)) +
  theme_bw()
long$aligned[[2]] %>% 
  ggplot(aes(x = aligned_x, y = signature)) +
  geom_line(aes(colour = mark_angle_direction)) +
  theme_bw()
long$aligned[[3]] %>% 
  ggplot(aes(x = aligned_x, y = signature)) +
  geom_line(aes(colour = mark_angle_direction)) +
  theme_bw()
```


```{r eval= FALSE}

class(long)
str(long)

long$angle[1]
long$aligned[[1]]

head(long$aligned[[1]])

head(long$aligned[[2]])

table(long$aligned[[1]]$mark_angle_direction)
table(long$aligned[[2]]$mark_angle_direction)
table(long$aligned[[3]]$mark_angle_direction)

long$aligned[[3]]$data
  
  




df <- rbind(long$aligned[[1]]$data[[1]],
      long$aligned[[2]]$data[[1]],
      long$aligned[[3]]$data[[1]])

dim(long$aligned[[1]]$data)
table(long$aligned[[2]]$mark_angle_direction)
table(long$aligned[[3]]$mark_angle_direction)

dim(df)
table(df$tool)

names(df)
table(df$tool)
table(df$mark)

```





